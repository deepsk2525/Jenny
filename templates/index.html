<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jenny - AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Navbar -->
  <header class="bg-indigo-600 text-white p-4 shadow">
    <h1 class="text-xl font-bold">Jenny - Your AI Assistant</h1>
  </header>

  <!-- Chat Container -->
  <main class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl bg-white shadow-lg rounded-2xl overflow-hidden flex flex-col h-[80vh]">
      
      <!-- Messages -->
      <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-3"></div>

      <!-- Input Box -->
      <form id="chat-form" class="flex border-t p-2 bg-gray-50 items-center">
        <input id="user-input" 
               type="text" 
               placeholder="Type a message..." 
               class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
        
        <!-- Voice Input Button -->
        <button type="button" id="voice-btn" 
                class="ml-2 px-4 py-2 bg-gray-300 text-black rounded-lg hover:bg-gray-400">
          üé§
        </button>

        <!-- Send Button -->
        <button type="submit" 
                class="ml-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Send
        </button>
      </form>
    </div>
  </main>

  <script>
  const chatForm = document.getElementById("chat-form");
  const chatBox = document.getElementById("chat-box");
  const userInput = document.getElementById("user-input");
  const voiceBtn = document.getElementById("voice-btn");

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    addMessage(message, "user");
    userInput.value = "";

    const typingEl = addMessage("Jenny is typing...", "bot", true);

    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message }),
      });
      const data = await response.json();

      typingEl.remove();

      // Create an empty bubble for Jenny
      const botMsgEl = addMessage("", "bot");

      // Start speaking immediately
      speakText(data.reply);

      // Type out text word by word
      typeOutText(data.reply, botMsgEl.querySelector("div"));
    } catch (error) {
      typingEl.remove();
      addMessage("‚ö†Ô∏è Error connecting to server.", "bot");
    }
  });

  // Add message to chat
  function addMessage(text, sender, isTemp = false) {
    const msgEl = document.createElement("div");
    msgEl.className = `flex ${sender === "user" ? "justify-end" : "justify-start"}`;
    msgEl.innerHTML = `
      <div class="${sender === "user" 
                    ? "bg-indigo-500 text-white" 
                    : "bg-gray-200 text-gray-900"} 
                    px-4 py-2 rounded-2xl max-w-xs whitespace-pre-wrap">
        ${text}
      </div>
    `;
    chatBox.appendChild(msgEl);
    chatBox.scrollTop = chatBox.scrollHeight;
    if (isTemp) return msgEl;
    return msgEl;
  }

  // ‚ú® Typing effect
  function typeOutText(fullText, el) {
    el.textContent = ""; 
    const words = fullText.split(" ");
    let i = 0;

    const interval = setInterval(() => {
      el.textContent += (i > 0 ? " " : "") + words[i];
      chatBox.scrollTop = chatBox.scrollHeight;
      i++;
      if (i >= words.length) clearInterval(interval);
    }, 150); // speed (ms per word)
  }

  // üé§ Voice input
  // üé§ Voice input
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  voiceBtn.addEventListener("click", () => {
    recognition.start();
    voiceBtn.textContent = "üéôÔ∏è Listening...";
  });

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userInput.value = transcript;
    voiceBtn.textContent = "üé§";

    // üöÄ Auto-send after speech recognized
    chatForm.dispatchEvent(new Event("submit"));
  };

  recognition.onend = () => {
    voiceBtn.textContent = "üé§";
  };

  recognition.onerror = () => {
    voiceBtn.textContent = "üé§";
  };
} else {
  voiceBtn.disabled = true;
  voiceBtn.textContent = "‚ùå";
}


  // üîä Speak reply
  function speakText(text) {
    if ("speechSynthesis" in window) {
      speechSynthesis.cancel(); // stop previous
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      speechSynthesis.speak(utterance);
    }
  }
</script>
</body>
</html>
